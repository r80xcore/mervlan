mervlan v0.48

IMPORTANT! Scripts does not follow main version. Every script has its own version.

NEW FILES:
lib_json.sh
Centralized JSON flag management with multi-match parsing to prevent key loss.
Seeded defaults once and updated json_get_flag/json_set_flag to preserve all entries.

lib_ssh.sh
Centralized SSH key checks, node credentials (NODE_SSH_USER / NODE_SSH_PORT), and flag syncing via the shared JSON helper.
Stopped rewriting unrelated flags when refreshing SSH state.

UPDATED FILES:
install.sh / uninstall.sh
Sourced the new helpers, reused ssh_keys_effectively_installed, and adopted the shared node credential getters.
Enabled custom NODE_SSH_USER / NODE_SSH_PORT support during install/uninstall.

update_mervlan.sh / sync_nodes.sh / execute_nodes.sh / collect_clients.sh / mervlan_boot.sh
Dropped unsupported Dropbear options, switched all SSH calls to the shared user/port helpers, and ensured remote operations use the new credentials.
dropbear_sshkey_gen.sh

Replaced the inline JSON writer with the centralized helper to fix the SSH_KEYS_INSTALLED/BOOT_ENABLED overwrite bug.

#############################################################
previous version 0.46 changes
CHANGES:

NEW FILES:
update_mervlan.sh v0.48
Fully automated updating script that will preserve your current settings and pull the newest gitgub main branch.
If any nodes/AP are setup with SSH key they will also be updated to this version.

mervlan_templates.sh v0.47
new template file containing everything needed and easily expandable.

REMOVED FILES:
all .tpl files are obsolete and now deleted.

UPDATED FILES:
heal_event.sh v0.47
heavily reworked to be better at finding and handling events that breaks
the VLAN bridges. Will do a 5-stage pass over 10 seconds when detecting 
a bridge compromising event. Is coupled with a CRU job that does a 1-pass
every 5 minutes silently. Will report every 12h. If any pass finds changes
inside the VLAN bridges, mervlan_manager.sh will be executed. Both heal_event
and mervlan_manager has locks, preventing hammering. Has a 90s cooldown.

service-event-handler.sh v0.47
Changed calls to heal-event to be run outside of the pipeline to prevent
that asuswrt-merlin always finishes last and queues heal_event.sh after
a VLAN compromising event is done, ensuring fast bridge healing.

mervlan_boot.sh v0.48
added CRU job calls. Moved BOOT_ENABLED to general.json

mervlan_templates.sh v0.48
updated node service-event-handler to match main changes.


#############################################################
previous version 0.46 changes

# execute_nodes.sh v0.45 - v0.46
# Reworked to fix broken paths

# mervlan_boot.sh v0.45 -> v0.46
# Added SSH-propagated node actions (nodeenable, nodedisable, setupenable, setupdisable) so main commands fan out to satellites.
# Hardened template injection logic; corrected service-event-nodes.tpl handling so the main router service handler no longer receives the node variant.

# mervlan_manager.sh v0.45 -> v0.46
# Queue-aware, timed restarts: skip duplicate restart_wireless/switch/httpd via /tmp/rc_service/ps and enforce timeouts.
# Global mkdir lock: prevents overlapping runs from clobbering bridges/interfaces.
# VAP wait cap: wait_for_interface limited to ~63 s (exponential backoff).
# Clean bridge teardown: detach all member ports before brctl delbr.
# Safer delif: ignore empty bridge names and dedupe in remove_from_all_bridges.
# Fail-fast env: exit if CHANGES or LOCKDIR arenâ€™t set.
# Full cmdlines: use ps w so token matching is reliable.
# Cleaned stray braces and adjusted client-refresh conditions in mervlan_manager.sh to Ensured only the main router runs collect_clients.sh

# service-event-handler.sh v0.45 -> v0.46
# Added debounce to deflect multi-clicks or multi-calls.
# Added missing executenodes_vlanmgr

# sync_nodes.sh v0.45 -> v0.46
# Hardened to create all runtime directories remotely before file sync.
# Added missing hw_settings.json, preventing the execution of some scripts.

# service-event-nodes.tpl
# Added TEMPLATE_2 mirroring the service-event-handler.sh on main. Used to prevent accidental writes to the main version.

# var_settings.sh v0.45 -> v0.46
# added several definitions that is used in the updated versions.

# index.html 
Updated index.html buttons to send actions through the unified queue, added modal button wiring, and maintained per-action logging/locking.

# mervlan.asp
# Restored action_mode="apply" and built policy-controlled wrappers in mervlan.asp, including sandboxed skip-refresh handling and the shared MVM_trigger pathway.
